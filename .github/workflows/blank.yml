name: Deploy FastAPI to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# ========================================
# 1. PRUEBAS UNITARIAS
# ========================================
jobs:
  tests:
    name: Pruebas unitarias en EC2
    runs-on: ubuntu-latest

    steps:
      - name: Ejecutar tests
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "=== PRUEBAS UNITARIAS ==="

            cd /home/ubuntu
            source venv/bin/activate

            pip install -r requirements.txt

            export PYTHONPATH=/home/ubuntu:$PYTHONPATH

            pytest tests/ -v --maxfail=1


# ========================================
# 2. DESPLIEGUE FASTAPI
# ========================================
  deploy:
    name: Despliegue Punto 1 - FastAPI
    runs-on: ubuntu-latest

    # Este job solo se ejecuta si tests pasa
    needs: tests

    steps:
      - name: Desplegar FastAPI
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "=== DESPLEGANDO FASTAPI ==="

            cd /home/ubuntu
            source venv/bin/activate

            echo "Deteniendo FastAPI anterior..."
            pkill -15 -f "uvicorn app.main:app" || true
            sleep 2

            echo "Iniciando FastAPI..."
            nohup uvicorn app.main:app \
              --host 0.0.0.0 \
              --port 8000 \
              > fastapi.log 2>&1 &

            sleep 5

            echo "Verificando servicio..."
            if curl -f http://localhost:8000/songs; then
              echo "✅ FastAPI desplegada correctamente"
            else
              echo "❌ FastAPI no responde"
              tail -n 40 fastapi.log
              exit 1
            fi
