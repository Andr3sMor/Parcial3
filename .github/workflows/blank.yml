name: Deploy FastAPI to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# ========================================
# 1. PRUEBAS UNITARIAS
# ========================================
jobs:
  tests:
    name: Pruebas unitarias en EC2
    runs-on: ubuntu-latest
    steps:
      - name: Ejecutar tests
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "=== PRUEBAS UNITARIAS ==="
            cd /home/ubuntu
            source venv/bin/activate
            pip install -r requirements.txt
            export PYTHONPATH=/home/ubuntu:$PYTHONPATH
            pytest tests/ -v --maxfail=1

# ========================================
# 2. DESPLIEGUE FASTAPI
# ========================================
  deploy:
    name: Despliegue Punto 1 - FastAPI
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - name: Desplegar FastAPI
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "=== DESPLEGANDO FASTAPI ... ==="
            cd /home/ubuntu
            source venv/bin/activate
            echo "Deteniendo FastAPI anterior (si existe)..."
            if [ -f fastapi.pid ]; then
              OLD_PID=$(cat fastapi.pid)
              if ps -p $OLD_PID > /dev/null; then
                kill $OLD_PID
                sleep 2
              fi
              rm -f fastapi.pid
            fi
            echo "Iniciando FastAPI..."
            nohup uvicorn app.main:app \
              --host 0.0.0.0 \
              --port 8000 \
              > fastapi.log 2>&1 &
            echo $! > fastapi.pid
            sleep 5
            echo "Verificando servicio..."
            if curl -f http://localhost:8000/songs; then
              echo "✅ FastAPI desplegada correctamente"
            else
              echo "❌ FastAPI no responde"
              tail -n 40 fastapi.log
              exit 1
            fi

# ========================================
# 3. EJECUTAR SPARK-SUBMIT EN CLUSTER ....
# ========================================
  spark_job:
    name: Ejecutar Spark-submit en nodo principal
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Ejecutar spark-submit en nodo Hadoop
        uses: appleboy/ssh-action@master
        with:
          host: "ec2-35-170-63-103.compute-1.amazonaws.com"
          username: "hadoop"
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            
            yes
            
            echo "=== Ejecutando spark-submit ==="
            spark-submit \
              --archives s3://chinook-data-lake-cmjm/scripts/pyspark_venv.tar.gz#environment \
              --conf spark.yarn.appMasterEnv.PYSPARK_PYTHON=./environment/bin/python \
              --conf spark.executorEnv.PYSPARK_PYTHON=./environment/bin/python \
              --packages org.mariadb.jdbc:mariadb-java-client:3.3.2 \
              s3://chinook-data-lake-cmjm/analytics/scripts/codiguito.py